<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>OKKHORPOTRYA ‚Äî All in One System</title>

<style>
  body { font-family: Arial; margin:0; background:#f4f4f4; }
  header { background:#000; color:#fff; padding:10px; text-align:center; }
  section { display:none; padding:20px; }
  .active { display:block; }

  input, select, textarea, button {
    width:100%; padding:10px; margin:10px 0; border-radius:6px;
  }
  .article-card { background:#fff; padding:15px; margin:10px 0; border-radius:8px; }
  img.thumb { width:100%; max-height:180px; object-fit:cover; border-radius:8px; }
  .like-box button { width:48%; }
</style>
</head>

<body>
<header>
  <h1>OKKHORPOTRYA ‚Äî All in One Admin System</h1>
</header>

<!-- LOGIN SECTION -->
<section id="loginSection" class="active">
  <h2>Admin Login</h2>
  <input id="loginEmail" type="email" placeholder="Email">
  <input id="loginPass" type="password" placeholder="Password">
  <button id="loginBtn">Login</button>
  <p id="loginError"></p>
</section>

<!-- DASHBOARD SECTION -->
<section id="dashboardSection">
  <h2>Dashboard</h2>
  <button onclick="showPage('submitSection')">‚úè Submit Article</button>
  <button onclick="showPage('categorySection')">üìö View Articles</button>
  <button id="logoutBtn">Logout</button>
  <br><br>
  <p><b>Logged in:</b> <span id="adminEmail"></span></p>
</section>

<!-- SUBMIT ARTICLE -->
<section id="submitSection">
  <h2>Publish New Article</h2>

  <input id="title" placeholder="Title">
  <label>Thumbnail</label>
  <input type="file" id="thumbnail">
  <label>Category</label>

  <select id="category">
    <option value="poem">Poem</option>
    <option value="news">News</option>
    <option value="review">Review</option>
    <option value="story">Story</option>
  </select>

  <textarea id="content" placeholder="Full content"></textarea>

  <button id="publishBtn">Publish</button>
  <button onclick="showPage('dashboardSection')">Back</button>
</section>

<!-- CATEGORY LIST -->
<section id="categorySection">
  <h2>Select Category</h2>

  <select id="catSelect">
    <option value="poem">Poem</option>
    <option value="news">News</option>
    <option value="review">Review</option>
    <option value="story">Story</option>
  </select>

  <button id="loadCat">Load</button>
  <div id="catList"></div>

  <button onclick="showPage('dashboardSection')">Back</button>
</section>

<!-- SINGLE ARTICLE VIEW -->
<section id="articleView">
  <h2 id="aTitle"></h2>
  <img id="aThumb" class="thumb" />
  <p id="aContent"></p>

  <div class="like-box">
    <button id="likeBtn">üëç Like</button>
    <button id="disBtn">üëé Dislike</button>
  </div>

  <button onclick="showPage('categorySection')">Back</button>
</section>

<!-- Firebase SDK -->
<script type="module">
  // ---------------------------------------
  // Firebase Setup
  // ---------------------------------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, getDocs, collection, query, where, updateDoc, increment } 
    from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut }
    from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import { getStorage, ref, uploadBytes, getDownloadURL }
    from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCnFgBxGYqkMkYCTCbPPJzo8fbbZmylcHY",
    authDomain: "okkhorpotrya.firebaseapp.com",
    projectId: "okkhorpotrya",
    storageBucket: "okkhorpotrya.firebasestorage.app",
    messagingSenderId: "401210408956",
    appId: "1:401210408956:web:958c0361306121244bbc79",
    measurementId: "G-VN5XLFYH8P"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);

  // ---------------------------------------
  // SECTION CONTROL
  // ---------------------------------------
  function showPage(id) {
    document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
    document.getElementById(id).classList.add("active");
  }

  // ---------------------------------------
  // LOGIN
  // ---------------------------------------
  loginBtn.onclick = () => {
    signInWithEmailAndPassword(auth, loginEmail.value, loginPass.value)
      .catch(err => loginError.textContent = err.message);
  };

  onAuthStateChanged(auth, user => {
    if (user) {
      adminEmail.textContent = user.email;
      showPage("dashboardSection");
    } else {
      showPage("loginSection");
    }
  });

  logoutBtn.onclick = () => signOut(auth);

  // ---------------------------------------
  // PUBLISH ARTICLE
  // ---------------------------------------
  publishBtn.onclick = async () => {
    const id = Date.now().toString();
    const file = thumbnail.files[0];

    const tRef = ref(storage, `thumbnails/${id}.jpg`);
    await uploadBytes(tRef, file);
    const imageURL = await getDownloadURL(tRef);

    await setDoc(doc(db, "articles", id), {
      id,
      title: title.value,
      content: content.value,
      category: category.value,
      thumbnail: imageURL,
      likes: 0,
      dislikes: 0,
      timestamp: Date.now()
    });

    alert("Published!");
    showPage("dashboardSection");
  };

  // ---------------------------------------
  // LOAD CATEGORY ARTICLES
  // ---------------------------------------
  loadCat.onclick = async () => {
    const cat = catSelect.value;
    catList.innerHTML = "";

    const q = query(collection(db, "articles"), where("category", "==", cat));
    const snap = await getDocs(q);

    snap.forEach(d => {
      const a = d.data();
      catList.innerHTML += `
        <div class="article-card" onclick="openArticle('${a.id}')">
          <img src="${a.thumbnail}" class="thumb">
          <h3>${a.title}</h3>
        </div>
      `;
    });
  };

  // ---------------------------------------
  // OPEN SINGLE ARTICLE
  // ---------------------------------------
  window.openArticle = async (id) => {
    const snap = await getDoc(doc(db, "articles", id));
    const a = snap.data();

    aTitle.textContent = a.title;
    aThumb.src = a.thumbnail;
    aContent.textContent = a.content;

    likeBtn.onclick = () => updateDoc(doc(db, "articles", id), { likes: increment(1) });
    disBtn.onclick = () => updateDoc(doc(db, "articles", id), { dislikes: increment(1) });

    showPage("articleView");
  };
</script>

</body>
</html>
